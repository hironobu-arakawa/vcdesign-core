# resolution_protocol.yaml
# Resolution Protocol (RP)
#
# Role:
#   Pre-decision interlock for promoting Meaning -> Resolution (responsibility-bearing).
#   RP does NOT decide the content of a solution. RP only checks whether promotion is allowed.
#
# IDG dependency:
#   RP is invoked only with an IDG gate_output.
#   If IDG blocks determinability, RP must NOT promote to Resolution and must route/return.
#
# Notes:
#   - Queueing to a responsibility pool is NOT a Resolution.
#   - Ownership becomes true only after explicit assignment is recorded.

protocols:
  rp:
    id: rp
    version: "1.2.0"
    status: "frozen"

    name:
      en: "Resolution Protocol (RP)"
      ja: "解決プロトコル（RP）"

    role:
      en: "Pre-decision interlock for Resolution promotion."
      ja: "Resolution 昇格のための判断前インターロック"

    non_goals:
      - en: "Operational procedure or runbook."
        ja: "運用手順・ランブック"
      - en: "Delegating or automating judgment."
        ja: "判断の代行・自動化"
      - en: "Providing solution content."
        ja: "解決策そのものの提示"
      - en: "Optimizing outcomes."
        ja: "最適化"

    applies_to:
      - resolution
      - boundary_crossing_into_responsibility

    # Fail-safe posture
    fail_safe:
      default: deny
      on_violation: quarantine

    # -------------------------------------------------------------------------
    # Input contract (what RP expects to receive)
    # -------------------------------------------------------------------------
    input_contract:
      # IDG output is REQUIRED. RP must not be invoked without it.
      idg_gate_output:
        required: true
        authoritative_spec: "/specs/determinability_gate.yaml"
        fields:
          decision:
            type: enum
            values: [pass, block]
          reason:
            type: enum
            values: [interface_determinable, not_determinable]
          annotations:
            type: object
            optional: true

      # Candidate judgment package (Meaning-side). RP does not validate truth.
      meaning_candidate:
        required: true
        fields:
          candidate_id: { type: string }
          summary: { type: string }
          hypothesis_ref: { type: string, optional: true }

      # Minimum trace bundle must exist for auditability.
      trace:
        required: true
        fields:
          fact_bundle_id: { type: string }
          decision_trace_refs:
            type: array
            items: { type: string }
          observed_at: { type: string, format: date-time }

      # Promotion intent (what responsibility would be created if promoted)
      promotion_intent:
        required: true
        fields:
          responsible_actor: { type: string }   # named human/org
          purpose: { type: string }
          scope: { type: string }
          expiry: { type: string, format: date-time }

    # -------------------------------------------------------------------------
    # Invariants (must always hold)
    # -------------------------------------------------------------------------
    invariants:
      - id: rp.inv.responsible_actor_required
        en: "A named responsible actor is required for any resolution."
        ja: "いかなる Resolution にも責務主体（人/組織）の明記が必要"

      - id: rp.inv.ai_cannot_finalize
        en: "AI systems must not finalize resolution; they may only propose candidates."
        ja: "AI は最終判断できず、候補提示に限定される"

      - id: rp.inv.fact_evidence_required
        en: "Evidence must reference Facts and Decision Traces; unstated assumptions are invalid."
        ja: "根拠は Fact と Decision Trace を参照し、暗黙前提は無効"

      - id: rp.inv.time_bound
        en: "Resolution must be purpose-bound and time-bound."
        ja: "Resolution は目的と期限（適用範囲）を持たねばならない"

      - id: rp.inv.idg_required
        en: "RP must receive an IDG gate output; otherwise deny."
        ja: "RP は IDG の出力を必須とし、欠落時は deny"

      - id: rp.inv.no_promotion_if_idg_block
        en: "If IDG blocks determinability, promotion to Resolution is forbidden."
        ja: "IDG が block の場合、Resolution への昇格は禁止"

      # Pool escalation safety (PR-2)
      - id: rp.inv.pool_queue_is_not_resolution
        en: "Enqueuing to a responsibility pool is a tracked waiting state, not a completed resolution."
        ja: "責任プールへの投入（キュー）は解決ではなく「解決待ち」の追跡状態である"

      - id: rp.inv.ownership_must_be_explicit
        en: "Responsibility must not be considered owned until an explicit owner assignment is recorded."
        ja: "明示的な担当割当が記録されるまで、責任が「確定した」とみなしてはならない"

    # -------------------------------------------------------------------------
    # Gate rules (for Resolution promotion)
    # NOTE: These rules govern promotion into responsibility (Resolution).
    # Routing/return actions are defined separately under "routing".
    # -------------------------------------------------------------------------
    gate_rules:
      # Promotion is allowed ONLY if ALL conditions are met.
      promotion_allowed_when:
        - idg_gate_output.decision == pass

      require:
        - responsible_actor
        - purpose
        - scope
        - expiry
        - fact_bundle_id
        - decision_trace_refs

      require_semantics:
        responsible_actor:
          description: "Named human/org that will own the responsibility after promotion."
        purpose:
          description: "Why this Resolution exists (what value continuity it protects)."
        scope:
          description: "Where the Resolution applies (boundary, system, org, time)."
        expiry:
          description: "When this Resolution must be reviewed/returned."
        fact_bundle_id:
          description: "Reference to immutable Facts."
        decision_trace_refs:
          description: "References to decision trace (meeting, ticket, log, etc)."

    # -------------------------------------------------------------------------
    # Routing / return actions (when promotion is not allowed)
    # -------------------------------------------------------------------------
    routing:
      # Routing is invoked when:
      #  - IDG blocks determinability OR
      #  - gate_rules.require is not satisfied
      when:
        - idg_gate_output.decision == block
        - missing_required_fields
      actions:
        - id: return_to_human
          target: human
          description:
            en: "Return for human judgment with explicit responsibility."
            ja: "人間判断へ正式返却（責務を明示）"
          output_state: RETURNED_TO_HUMAN

        - id: return_to_pool
          target: responsibility_pool
          description:
            en: "Enqueue to responsibility pool (NOT a Resolution)."
            ja: "責任プールへ投入（Resolution ではない）"
          required_fields:
            - target_pool_id
          output_state: WAITING_FOR_ASSIGNMENT

      pool_rules:
        # Queue is NOT ownership. Ownership becomes true only after assignment.
        ownership_state_model:
          WAITING_FOR_ASSIGNMENT:
            owned: false
          ASSIGNED_TO_OWNER:
            owned: true

        # RP only references pool_id. Pool definition/ops live in binding/manifest.
        pool_reference_only: true

    # -------------------------------------------------------------------------
    # Output contract (what RP emits)
    # -------------------------------------------------------------------------
    output_contract:
      fields:
        rp_result:
          type: enum
          values: [PROMOTED_TO_RESOLUTION, ROUTED, DENIED, QUARANTINED]

        resolution_record:
          optional: true
          emitted_when: PROMOTED_TO_RESOLUTION
          fields:
            resolution_id: { type: string }
            responsible_actor: { type: string }
            purpose: { type: string }
            scope: { type: string }
            expiry: { type: string, format: date-time }
            trace:
              fact_bundle_id: { type: string }
              decision_trace_refs:
                type: array
                items: { type: string }

        routing_record:
          optional: true
          emitted_when: ROUTED
          fields:
            action_id: { type: string }  # return_to_human / return_to_pool
            state: { type: string }      # RETURNED_TO_HUMAN / WAITING_FOR_ASSIGNMENT
            target_pool_id: { type: string, optional: true }
            reason: { type: string }

        violations:
          optional: true
          emitted_when: [DENIED, QUARANTINED]
          fields:
            violation_ids:
              type: array
              items: { type: string }

    # -------------------------------------------------------------------------
    # Closure
    # -------------------------------------------------------------------------
    closure:
      statement:
        en: "RP treats stopping and returning as formal outcomes. It never replaces human responsibility."
        ja: "RP は止める／返すを正式な成果として扱い、人間の責任を置き換えない。"
