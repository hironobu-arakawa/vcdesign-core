# vcdesign_core.yaml
version: 0.3
kind: vcdesign_core
id: vcdesign_boundary_contracts

philosophy:
  intent:
    - "特定条件（契約・状態・計測）が満たされる限り、ドメインを問わず再利用できる"
    - "場所（OT/IT等）ではなく、情報の種類と契約で設計を固定する"
    - "同期前提を置かず、欠損/遅延/重複/補完を状態として扱う"
    - "AI出力は責務スコープで制限し、誤用を構造で防ぐ"

axioms:
  - id: fact_is_immutable
    statement: "Factは不変（append-only）"
  - id: interpretation_is_versioned
    statement: "Interpretationは版管理され、再解釈可能である"
  - id: decisions_stay_in_responsible_domain
    statement: "最終判断は責任を持つドメインに残る"
  - id: sync_is_exception
    statement: "同期は例外であり、非同期を標準として扱う"

domains:
  - id: source_domain
    role: "facts originate here"
  - id: platform_domain
    role: "transport/store/compute without final judgement"
  - id: responsible_domain
    role: "final judgement and operational decision lives here"

responsibility_model:
  scopes:
    source_domain:
      description: "facts originate here"
    platform_domain:
      description: "no final judgement; transport/store/compute"
    responsible_domain:
      description: "final judgement lives here"
  visibility_rules:
    allowed_visibility_values: [source_domain, platform_domain, responsible_domain]

artifacts:
  fact:
    description: "Observed facts (immutable)"
    properties:
      immutable: true
      append_only: true
      responsibility_scope: source_domain
      required_fields:
        - timestamp
        - source_id
        - value
        - quality_state
        - provenance
        - time_model

  decision_trace:
    description: "Decision context recorded as fact"
    properties:
      immutable: true
      append_only: true
      responsibility_scope: responsible_domain
      visibility_scope: responsible_domain
      required_fields:
        - timestamp
        - actor_role
        - action
        - reason
        - evidence_ref

  interpretation:
    description: "Versioned definition/derivation of meaning"
    properties:
      versioned: true
      reversible: true
      responsibility_scope: platform_domain
      required_fields:
        - version
        - model_checksum
        - read_at
        - inputs

  hypothesis:
    description: "Candidate interpretation generated by analysis/AI"
    properties:
      candidate_only: true
      responsibility_scope: platform_domain
      must_include:
        - confidence
        - rationale
        - evidence_links

  suggestion:
    description: "Non-binding recommendation to responsible domain"
    properties:
      non_binding: true
      responsibility_scope: platform_domain
      must_include:
        - options
        - tradeoffs
        - safety_notes
        - evidence_links

quality_model:
  states:
    ok: "valid"
    missing: "missing"
    late: "late_arrival"
    duplicate: "duplicate_delivery"
    corrected: "corrected/backfilled"
    rejected: "contract_violation_or_quarantine"
  transitions:
    - from: missing
      to: corrected
      when: backfill_success
    - from: ok
      to: late
      when: arrival_after_slo_window
    - from: ok
      to: duplicate
      when: same_idempotency_key
    - from: any
      to: rejected
      when: contract_violation

time_model:
  fact_time_fields:
    device_timestamp: "source clock"
    observed_at: "receiver observation time"
    ingested_at: "storage commit time"
  interpretation_time_fields:
    read_at: "reference time used for computation"
  derived_metrics:
    latency: "ingested_at - observed_at"
    clock_skew: "observed_at - device_timestamp"

provenance_model:
  fact_required:
    - config_checksum
    - calibration_valid_from
    - calibration_valid_to
  interpretation_required:
    - model_checksum
    - inputs
  checksum:
    algorithm: "sha256(normalized_yaml)"
    normalization: "sort_keys + strip_comments + canonical_numbers"

contracts:
  - contract_id: fact_ingest
    name: "Fact Ingest Contract"
    in:
      artifact: fact
      required_fields: [timestamp, source_id, value]
      forbidden_fields: [interpretation, hypothesis, suggestion]
    out:
      artifact: fact
      required_fields: [quality_state, provenance, time_model]
    handling:
      missing: allow
      late_arrival: allow
      duplicate: absorb
    error_handling:
      on_violation: quarantine  # quarantine | reject | log_only
    guarantees:
      append_only: true
      idempotent: true

  - contract_id: fact_to_interpretation
    name: "Fact to Interpretation Contract"
    in:
      artifact: fact
      required_fields: [quality_state, provenance, time_model]
    out:
      artifact: interpretation
      required_fields: [version, model_checksum, read_at, inputs]
    handling:
      missing: backfill_only
      late_arrival: recompute
    error_handling:
      on_violation: reject
    guarantees:
      versioned: true
      reversible: true

  - contract_id: suggestion_return
    name: "Non-binding Suggestion Contract"
    in:
      artifact: suggestion
      required_fields: [non_binding, options, tradeoffs, safety_notes, evidence_links]
    gate:
      require:
        - key: responsibility_scope
          op: equals
          value: responsible_domain
        - key: decision_trace.visibility_scope
          op: equals
          value: responsible_domain
      forbid:
        - auto_control
        - final_decision
    error_handling:
      on_violation: log_only

idempotency:
  idempotency_key:
    definition: "hash(source_id, fact.time_model.device_timestamp, value_fingerprint?)"
    scope: fact
  duplicate_policy:
    record_quality_state: duplicate
    upper_layer_default: exclude_duplicate
  database_constraints_guidance:
    - "UNIQUE(source_id, idempotency_key)"

append_only_policy:
  enforcement_guidance:
    - "writer role: INSERT only"
    - "reject UPDATE/DELETE via policy/trigger"
    - "audit log for inserts"
  isolation_guidance:
    - "separate control plane from observation/suggestion plane when applicable"

slo:
  realtime:
    latency_p95_seconds: null
    missing_rate_monthly_max: null
    duplicate_rate_monthly_max: null
  record:
    completeness_monthly_min: null
    correction_latency_hours_p95: null
    backfill_success_rate_min: null

error_budget:
  monthly:
    realtime_missing_allowance: null
    realtime_latency_violation_allowance: null
    record_backfill_failure_allowance: null
  when_exceeded:
    standard_actions:
      - degrade_features
      - freeze_changes
      - raise_incident
    extension:
      allow_custom_actions: true
      custom_actions: []

observability:
  metric_dimensions:
    standard_tags:
      - contract_id
      - domain_id
      - artifact_type
      - source_id

  metrics:
    - name: missing_rate
      by: [contract_id, domain_id, artifact_type, source_id]

    - name: latency_distribution
      by: [contract_id, domain_id, artifact_type, source_id]
      definition: "fact.time_model.ingested_at - fact.time_model.observed_at"

    - name: clock_skew_distribution
      by: [contract_id, domain_id, artifact_type, source_id]
      definition: "fact.time_model.observed_at - fact.time_model.device_timestamp"

    - name: backfill_rate
      by: [contract_id, domain_id, artifact_type, source_id]

    - name: duplicate_rate
      by: [contract_id, domain_id, artifact_type, source_id]

    - name: model_diff
      by: [contract_id, domain_id, artifact_type]
      definition: "interpretation.model_checksum changed"

  dashboards:
    required_views:
      - "realtime_health"
      - "record_health"
    ui_badges:
      - provisional
      - confirmed
      - corrected_vX

  alerting_policy:
    # coreは「形式」を標準化。閾値はbindingで上書きする。
    rules:
      - id: missing_rate_threshold
        alert_on:
          any_of:
            - expr: "missing_rate > threshold"
        severity: warning
        threshold: null
        window: "5m"

      - id: latency_p95_threshold
        alert_on:
          any_of:
            - expr: "latency_p95 > threshold"
        severity: critical
        threshold: null
        window: "5m"
